{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>ESP32 Device Management</h2>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Device Status</h5>
            <div id="statusDisplay" class="alert alert-info">
                Checking status...
            </div>
            
            <div class="form-group mb-3">
                <label for="deviceId">Device ID:</label>
                <input type="text" class="form-control" id="deviceId" placeholder="Enter device ID">
            </div>
            
            <div class="btn-group" role="group">
                <button id="connectBtn" class="btn btn-success">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>
                    <i class="fas fa-power-off"></i> Disconnect
                </button>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Recent Readings</h5>
            <div id="readingsTable">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Reading Type</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="readingsBody">
                        <!-- Readings will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let statusCheckInterval;

function updateStatus(deviceId) {
    fetch(`/esp32/status/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.className = `alert alert-${data.connected ? 'success' : 'warning'}`;
            statusDisplay.textContent = data.connected ? 'Connected' : 'Disconnected';
            
            document.getElementById('connectBtn').disabled = data.connected;
            document.getElementById('disconnectBtn').disabled = !data.connected;
        })
        .catch(error => {
            console.error('Error checking status:', error);
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.className = 'alert alert-danger';
            statusDisplay.textContent = 'Error checking status';
        });
}

document.getElementById('connectBtn').addEventListener('click', function() {
    const deviceId = document.getElementById('deviceId').value;
    if (!deviceId) {
        alert('Please enter a device ID');
        return;
    }
    
    fetch('/esp32/connect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(deviceId);
            // Start periodic status check
            statusCheckInterval = setInterval(() => updateStatus(deviceId), 5000);
        } else {
            alert('Failed to connect: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error connecting to device');
    });
});

document.getElementById('disconnectBtn').addEventListener('click', function() {
    const deviceId = document.getElementById('deviceId').value;
    if (!deviceId) {
        alert('Please enter a device ID');
        return;
    }
    
    fetch('/esp32/disconnect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(deviceId);
            // Clear the status check interval
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        } else {
            alert('Failed to disconnect: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error disconnecting device');
    });
});

// Update readings table
function updateReadings(deviceId) {
    fetch(`/esp32/readings/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('readingsBody');
            tbody.innerHTML = '';
            
            data.readings.forEach(reading => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(reading.timestamp).toLocaleString()}</td>
                    <td>${reading.reading_type}</td>
                    <td>${reading.value}</td>
                    <td><span class="badge bg-${reading.status === 'normal' ? 'success' : 'danger'}">${reading.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => console.error('Error updating readings:', error));
}

// Start updating readings when a device is connected
document.getElementById('connectBtn').addEventListener('click', function() {
    const deviceId = document.getElementById('deviceId').value;
    if (deviceId) {
        setInterval(() => updateReadings(deviceId), 5000);
    }
});
</script>
{% endblock %}